workflows:
  ios-automatic-code-signing:
    name: CiCd Dyz Test
    instance_type: mac_mini_m2
    working_directory: ios/
    integrations:
      app_store_connect: "eSparkBiz Technologies Private Limited"
    environment:
      groups:
        - cicd Megic
      ios_signing:
        distribution_type: app_store
        bundle_identifier: com.cicdmegic.app
      vars:
        XCODE_WORKSPACE: "Runner.xcworkspace"
        XCODE_SCHEME: "Runner"
        BUNDLE_ID: com.cicdmegic.app
        APP_STORE_APP_ID: 6692628444
        APP_STORE_CONNECT_API_KEY: "testing/AuthKey_FZD8N8362T"
        xcode: 15.2
        FLUTTER_VERSION: "3.24.3"
      cocoapods: default
    scripts:
      - name: Install Flutter
        script: |
          git clone https://github.com/flutter/flutter.git
          cd flutter
          git checkout $FLUTTER_VERSION  # Use specified version
          export PATH="$PATH:$(pwd)/bin"
          flutter channel stable
          flutter upgrade
      - name: Get Flutter packages
        script: |
          flutter packages pub get
      - name: Install pods
        script: |
          find . -name "Podfile" -execdir pod install \;
      - name: Set up keychain to be used for codesigning using Codemagic CLI 'keychain' command
        script: |
          keychain initialize
      - name: Set up code signing settings on Xcode project
        script: |
          xcode-project use-profiles
      - name: Clean build folder
        script: |
          flutter clean
          rm -rf ios/Pods
          rm -rf ios/Podfile.lock
          flutter pub get
          pod install --repo-update
      - name: Flutter build ipa
        script: |
          flutter build ipa --release \
            --build-name=2.0.0 \
            --build-number=2 \
            --export-options-plist=/Users/builder/export_options.plist
    artifacts:
      - build/ios/ipa/*.ipa
    publishing:
      app_store_connect:
        api_key: $APP_STORE_CONNECT_PRIVATE_KEY
        key_id: $APP_STORE_CONNECT_KEY_IDENTIFIER
        issuer_id: $APP_STORE_CONNECT_ISSUER_ID
        submit_to_testflight: true
        submit_to_app_store: false
      email:
        recipients:
          - iostest680@gmail.com
        notify:
          success: true
          failure: true

  ios-workflow:
    name: iOS Workflow
    # instance_type: mac_mini
    max_build_duration: 120
    environment:
      vars:
        XCODE_WORKSPACE: "Runner.xcworkspace"
        XCODE_SCHEME: "Runner"
        # https://docs.codemagic.io/code-signing-yaml/signing-ios/
        APP_STORE_CONNECT_ISSUER_ID: "69a6de82-e81a-47e3-e053î‚ˆ5b8c7c11a4d1" # <-- Put your encrypted App Store Connect Issuer Id here
        APP_STORE_CONNECT_KEY_IDENTIFIER: "R97TNQCJSB" # <-- Put your encrypted App Store Connect Key Identifier here
        APP_STORE_CONNECT_PRIVATE_KEY: "MIGTAgEAMBMGByqGSM49AgEGCCqGSM49AwEHBHkwdwIBAQQgX41ItzCIHwxuBEP7VOCSmj+Zx4yK9rybRPRLSuckG02gCgYIKoZIzj0DAQehRANCAAQ1763TfiNPWIrvBuyFiB3hK5SPsQZ2ffpc889ByvObECT5dNUxEr0dVJ2G4HhcGoZ7/d5ONUE+0yfFLfw6T3xa" # <-- Put your encrypted App Store Connect Private Key here
        APPLE_ID: "info@esparkinfo.com" # <-- Put your encrypted Apple Id email address here
        APP_SPECIFIC_PASSWORD: "123456789" # <-- Put your encrypted App Specific password here. See here for more information - https://support.apple.com/en-us/HT204397
        BUNDLE_ID: "com.cicdmegic.app" # <-- Put your bundle id here
        APP_STORE_ID: 6692628444  # <-- Use the TestFlight Apple id number (An automatically generated ID assigned to your app) found under General > App Information > Apple ID.
      flutter: stable
      xcode: latest
      cocoapods: default
    scripts:
      - name: Set up keychain to be used for codesigning using Codemagic CLI 'keychain' command
        script: |
          keychain initialize
      - name: Fetch signing files
        script: |
          app-store-connect fetch-signing-files $BUNDLE_ID --type IOS_APP_STORE --create
      - name: Use system default keychain
        script: |
          keychain add-certificates
      - name: Set up code signing settings on Xcode project
        script: |
          xcode-project use-profiles
      - name: Get Flutter packages
        script: |
          cd . && flutter packages pub get
      - name: Flutter analyze
        script: |
          cd . && flutter analyze
      - name: Flutter unit tests
        script: |
          cd . && flutter test
        ignore_failure: true
      - name: Install pods
        script: |
          find . -name "Podfile" -execdir pod install \;
      - name: Flutter build ipa and automatic versioning
        script: |
          flutter build ipa --release \
          --build-name=1.0.0 \
          --build-number=$(($(app-store-connect get-latest-testflight-build-number "$APP_STORE_ID") + 1)) \
          --export-options-plist=/Users/builder/export_options.plist
    artifacts:
      - build/ios/ipa/*.ipa
      - /tmp/xcodebuild_logs/*.log
      - flutter_drive.log
    publishing:
      # See the following link for details about email publishing - https://docs.codemagic.io/publishing-yaml/distribution/#email
      email:
        recipients:
          - user_1@example.com
          - user_2@example.com
        notify:
          success: true     # To receive a notification when a build succeeds
          failure: false    # To not receive a notification when a build fails              # To not receive a notification when a build fails
      app_store_connect: # https://docs.codemagic.io/publishing-yaml/distribution
        apple_id: $APPLE_ID
        password: $APP_SPECIFIC_PASSWORD
